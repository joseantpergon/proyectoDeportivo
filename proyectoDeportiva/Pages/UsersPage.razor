@page "/users"

@using Microsoft.AspNetCore.Identity;
@using Microsoft.AspNetCore.Http;
@using System.Text.RegularExpressions
@using System.ComponentModel.DataAnnotations
@using System.Drawing
@using System.Globalization
@using Color = MudBlazor.Color
@using System.Collections.Immutable
@using proyectoDeportiva.Areas.Identity.Data
@using proyectoDeportiva.Data;

@inject UserManager<User> _UserManager
@inject AuthenticationStateProvider _authenticationStateProvider
@inject AuthenticationStateProvider _auth
@inject NavigationManager _navigationManager
@inject ApplicationDbContext _ApplicationDbContext;
@inject IHttpContextAccessor _httpContextAccessor
@inject IDialogService _dialogService;

<MudTabs  Outlined="true">
    <MudTabPanel Text="Usuarios" Icon="@Icons.Material.Filled.Person" >
        <MudGrid>
            <MudItem xs="12" md="12">
                <MudPaper Style="margin:auto; padding:15px" MaxWidth="1000px" Width="80%">
                    <h4>Crear nuevo usuario</h4>
                    <MudText Style="color:red" if="@errorMessage">@errorMessage</MudText>
                    <MudForm @ref="form">

                        <MudTextField @bind-Value="userName" Label="Nombre" Required Validation="@NameValidation" />
                         <MudTextField @bind-Value="userSurname" Label="Apellidos" Required Validation="@SurnameValidation" />
                         <MudTextField Label="Email" @bind-Value="userEmail" Required Validation="@EmailValidation" />
                         <MudTextField Label="Número de Teléfono" @bind-Value="userPhone" Required Validation="@PhoneValidation" />
                         <MudSelect Label="Rol" @bind-Value="userRole" Required>
                            <MudSelectItem Value="RoleUser">Usuario</MudSelectItem>
                            <MudSelectItem Value="RoleAdmin">Administrador</MudSelectItem>
                        </MudSelect>
                        <MudTextField Label="DNI" @bind-Value="userDNI" Required="true" Validation="@DNIValidation" />
                        <MudDatePicker Label="Fecha de nacimiento" Editable="true" @bind-Date="userFechaNacimiento" Mask="@(new DateMask("dd/MM/yyyy"))" DateFormat="dd/MM/yyyy" />


                        <MudButton OnClick="Submit" Style="margin: 20px" Color="Color.Dark" Variant="Variant.Filled">Crear Usuario</MudButton>
                    </MudForm>

                </MudPaper>
                </MudItem>
        </MudGrid>
    </MudTabPanel>
</MudTabs>





@code {


    private string searchTerm = "";
    private List<User> users = new List<User>();
    private List<User> filteredUsers => users.Where(u => u.UserName.StartsWith(searchTerm, StringComparison.OrdinalIgnoreCase)).ToList();

    private string userName;
    private string userSurname;
    private string userUserName;

    private string userEmail;
    private string userPhone;
    private string userRole;
    private string userDNI;
    private DateTime? userFechaNacimiento;
    private DateTime userFechaRegistro;


    MudForm form;


    private string error;
    private string errorData;
    private string errorMessage;


    private string RoleAdmin = "ADMIN";

    private string RoleUser = "USER";



    protected override async void OnInitialized()
    {
        bool bucle = true;
        while (bucle)
        {
            try
            {

                

                users = _ApplicationDbContext.Users.ToList();
                bucle = false;
            }
            catch (InvalidOperationException e)
            {
                await Task.Delay(100);

            }
        }

    }


    private List<User> FilterUsers()
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            return users;
        }

        // Filtra los usuarios por el término de búsqueda que comienza con el nombre del usuario
        return users.Where(u => u.UserName.StartsWith(searchTerm, StringComparison.OrdinalIgnoreCase)).ToList();
    }

    private string NameValidation(string name)

    {
        if (string.IsNullOrWhiteSpace(name))
        {
            return "¡El nombre es obligatorio!";
        }

        // Puedes agregar otras validaciones según tus necesidades

        return null;
    }

    private string SurnameValidation(string surname)
    {
        if (string.IsNullOrWhiteSpace(surname))
        {
            return "¡Los apellidos son obligatorios!";

        }

        // Puedes agregar otras validaciones según tus necesidades

        return null;
    }


    private string EmailValidation(string email)
    {
        if (string.IsNullOrWhiteSpace(email))
        {
            return "¡El correo electrónico es obligatorio!";
        }


        // Verificar que el correo electrónico tiene un formato válido
        if (!IsValidEmail(email))
        {
            return "El formato del correo electrónico no es válido.";
        }

        return null;
    }

    private bool IsValidEmail(string email)
    {
        try
        {
            var addr = new System.Net.Mail.MailAddress(email);
            return addr.Address == email;
        }
        catch
        {
            return false;
        }
    }

    private string PhoneValidation(string phoneNumber)
    {
        if (string.IsNullOrWhiteSpace(phoneNumber))
        {
            return "¡El número de teléfono es obligatorio!";
        }

        // Verificar que el número de teléfono tiene 9 dígitos
        if (!Regex.IsMatch(phoneNumber, @"^\d{9}$"))
        {
            return "Número de teléfono inválido. Debe contener 9 dígitos.";
        }

        return null;
    }

    private string DNIValidation(string dni)
    {
        if (string.IsNullOrWhiteSpace(dni))
        {
            return "¡El DNI es obligatorio!";
        }

        // Verificar el formato del DNI (8 números + 1 letra)
        if (!Regex.IsMatch(dni, @"^\d{8}[A-Za-z]$"))
        {
            return "Formato de DNI inválido. Por favor, ingrese 8 números seguidos de una letra.";
        }

        // Verificar la letra del DNI
        var numbers = int.Parse(dni.Substring(0, 8));
        var expectedLetter = GetDNILetter(numbers);

        if (!dni.EndsWith(expectedLetter.ToString(), StringComparison.OrdinalIgnoreCase))
        {
            return "DNI inválido. La letra proporcionada no coincide con la letra esperada.";
        }

        return null;
    }

    private char GetDNILetter(int numbers)
    {
        string validLetters = "TRWAGMYFPDXBNJZSQVHLCKE";
        int remainder = numbers % 23;
        return validLetters[remainder];
    }


    public string GenerateUsername(string name, string surname)
    {
        var generatedUsername = "";


        // generatedUsername += char.ToUpper(name[0]);

        var nameParts = name.Split(' ');
        foreach (var namePart in nameParts)
        {
            generatedUsername += char.ToUpper(namePart[0]);
        }


        var surnameParts = surname.Split(' ');

        foreach (var part in surnameParts)
        {
            generatedUsername += part.ToLower();
        }

        return generatedUsername;
    }

    private async void Submit()
    {

        if (form != null)
        {
            // Utiliza la validación del modelo para verificar los datos
            await form.Validate();
            var isValid = form.IsValid;

            if (isValid)
            {
                errorMessage = "";

                try
                {
                    userUserName = GenerateUsername(userName, userSurname);
                    var userUserNameCap = char.ToUpper(userUserName[0]) + userUserName.Substring(1).ToLower();

                    // Normaliza el nombre de usuario y el correo 
                    var normalizedUserName = userName.ToUpper();
                    var normalizedEmail = userEmail.ToUpper();
                    var DNISinLetra = userDNI.Substring(0, 8);

                    var password = DNISinLetra + "." + userUserNameCap;

                    // Verifica si el correo electrónico ya existe en la base de datos
                    var existingUser = await _UserManager.FindByEmailAsync(normalizedEmail);
                    if (existingUser != null)
                    {
                        errorMessage = "El correo electrónico ya está registrado.";
                        return;
                    }

                    userFechaRegistro = DateTime.Now;

                    // Crea un nuevo usuario
                    var newUser = new User()
                        {
                            Name = userName,

                            Surname = userSurname,


                            UserName = userUserName,
                            NormalizedUserName = normalizedUserName,

                            Email = userEmail,
                            NormalizedEmail = normalizedEmail,

                            PhoneNumber = userPhone,

                            Rol = RoleUser,

                            DNI = userDNI.ToUpper(),
                            FechaNacimiento = userFechaNacimiento ?? DateTime.MinValue,
                            FechaRegistro = userFechaRegistro,
                            ProfilePicture = new byte[0],
                        };

                    // Usa el UserManager para crear el usuario y asignar la contraseña
                    var result = await _UserManager.CreateAsync(newUser, password);

                    // Si la creación del usuario no tiene éxito, muestra el mensaje de error
                    if (!result.Succeeded)
                    {
                        errorMessage = "Error al crear el usuario: " + string.Join(", ", result.Errors.Select(error => error.Description));
                    }

                    // Actualizar la lista de usuarios independientemente de las advertencias
                    await _ApplicationDbContext.SaveChangesAsync();
                    users = _ApplicationDbContext.Users.ToList();

                }
                catch (Exception e)
                {
                    errorMessage = e.Message;
                    errorData = e.Data.ToString();
                    error = e.ToString();
                }
            }
            else
            {
                errorMessage = "Rellene todos los campos";
            }
        }


    }
}
